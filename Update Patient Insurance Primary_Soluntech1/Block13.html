<script>
    document.addEventListener("DataPageReady", function (ev) {
        const uniqueSuffix = ev.detail.uniqueSuffix;
        const appKey = ev.detail.appKey;
        if (appKey === "F03D40001a035527f3b340c58109") {
            setTimeout(() => {
                const secondaryDisplay = $("#secondaryDisplay");
                const insuranceFront = secondaryDisplay.find(
                    "img[id='displayInsuranceFront']"
                );
                const insuranceBack = secondaryDisplay.find(
                    "img[id='displayInsuranceBack']"
                );
                if (!insuranceBack.attr("src") && !insuranceFront.attr("src")) {
                    secondaryDisplay.hide();
                }
            }, 10);
        }

        if (appKey != "F03D40005a903b8e9e674f07b4d9") return;
        const form = $(`form[action^='https://caspio.helixvm.com/dp/${appKey}']`);
        const button = form.find(`input[id='Mod0EditRecord${uniqueSuffix}']`);
        button.hide();
        function handleDateChange() {
            const staleInsuranceTime = new Date(cbParamVirtual3.val());
            const createdDate = new Date(cbParamVirtual4.val());
            if (staleInsuranceTime > createdDate) {
                $(
                    "#labelEditRecordInsuranceFront, #labelEditRecordInsuranceBack"
                ).hide();
            }
        }

        const cbParamVirtual3 = form.find("input[name=cbParamVirtual3]");
        cbParamVirtual3.change(handleDateChange);

        const cbParamVirtual4 = form.find("input[name=cbParamVirtual4]");
        cbParamVirtual4.change(handleDateChange);
        let script = document.createElement("script");
        script.type = "text/javascript";
        script.id = "secondaryDisplayScript";
        if ($("#secondaryDisplayScript").length === 0) {
            script.src =
                "https://caspio.helixvm.com/dp/F03D40001a035527f3b340c58109/emb";
            const secondaryDisplayContainer =
                document.getElementById("secondaryDisplay");
            if (secondaryDisplayContainer) {
                secondaryDisplayContainer.appendChild(script);
            }
        }

        function insuranceInputs(InsuranceFrontString) {
            const divFront =
                InsuranceFrontString === "Front" ? "cbFormBlock3_" : "cbFormBlock4_";
            const divInsurance = $(`div[class^='cbFormFieldCell ${divFront}']`);
            const logo =
                InsuranceFrontString === "Front"
                    ? "fa fa-id-card"
                    : "fa fa-credit-card-alt";
            const currentImgTag = divInsurance.find(
                `img[src^='https://caspio.helixvm.com/dp/${appKey}/files']`
            );
            const inputFieldName = "EditRecordInsurance";
            if ($(`#insurance${InsuranceFrontString}ImgContainer`).length === 0) {
                divInsurance.append(
                    `
                      <div  id="insurance${InsuranceFrontString}ImgContainer">
                          <i class="${logo}" aria-hidden="true" id="insuranceFrontBackLogo"></i>
                        <span class="insurance${InsuranceFrontString}UploadedTitle">
                        ${InsuranceFrontString} side image uploaded</span>
  
                          <img id="outputInsurance${InsuranceFrontString}"   />
                          <h1 class="insurance${InsuranceFrontString}Title">Upload ${InsuranceFrontString} side</h1>
                          <p class="insurance${InsuranceFrontString}Paragraph">No larger than 5mb in size.</p>
  
                  <div id="${InsuranceFrontString}SideDiv">
                  <button type="button"  id='${currentImgTag.length === 1 ? "ReplaceBtn" : `UploadBtn`
                    }' >
                      <label for="${inputFieldName}${InsuranceFrontString}" id="label${inputFieldName}${InsuranceFrontString}">
                         ${currentImgTag.length === 1
                        ? "Replace Image?"
                        : `Upload ${InsuranceFrontString} Side`
                    }
                      </label>
                  </button>
                  </div>
                      </div>
  
                  `
                );
            }
            divInsurance.width("338px");
            divInsurance.find("a").hide();
            divInsurance.find("input[type='file']").hide();
            divInsurance.find(".cbFormData").hide();
            if (currentImgTag.length === 1) {
                $(`#outputInsurance${InsuranceFrontString}`).attr(
                    "src",
                    currentImgTag.attr("src")
                );
                $(`#outputInsurance${InsuranceFrontString}`).show();
                currentImgTag.hide();
                $(`.insurance${InsuranceFrontString}Title`).hide();
                $(`.insurance${InsuranceFrontString}Paragraph`).hide();
                $(`.insurance${InsuranceFrontString}UploadedTitle`).show();
            } else {
                $(`.insurance${InsuranceFrontString}UploadedTitle`).hide();
            }

            $(`#${inputFieldName}${InsuranceFrontString}`).on("change", function () {
                const labelArchivo = $(`#label${inputFieldName}${InsuranceFrontString}`);
                if (this.value != "") {
                    labelArchivo.html("Replace Image?");
                } else {
                    if ($(`#outputInsurance${InsuranceFrontString}`).attr("src")) {
                        labelArchivo.html("Replace Image?");

                    } else {
                        labelArchivo.html('Selecciona un archivo')
                    }
                }
            });
            $(`#${inputFieldName}${InsuranceFrontString}`).on("change", (event) =>
                changeImage(event, InsuranceFrontString, currentImgTag)
            );
        }
        insuranceInputs("Front");
        insuranceInputs("Back");

        function changeImage(event, InsuranceFrontString = "", currentImgTag) {
            var reader = new FileReader();
            reader.onload = function () {
                const imageContainter = $(`#outputInsurance${InsuranceFrontString}`);
                $(`.insurance${InsuranceFrontString}Title`).hide();
                $(`.insurance${InsuranceFrontString}Paragraph`).hide();
                $(`#${InsuranceFrontString}SideDiv`)
                    .find("#UploadBtn")
                    .attr("id", "ReplaceBtn");
                $(`.insurance${InsuranceFrontString}UploadedTitle`).show();
                imageContainter.show();
                imageContainter.attr("src", reader.result);
            };
            reader.readAsDataURL(event.target.files[0]);
        }

        const btnNew = form.find('[name="CreateNewInsurance"]');

        const nextPage = form.find('[name="EditRecordNextPage"]');
        btnNew.click(function (event) {
            event.preventDefault();
            const createNew = form.find('[name="EditRecordCreateNew"]');
            createNew.val("Y");
            nextPage.val("insurance-primary");
            form.submit();
        });
        const btnContinue = form.find('[name="ContinueInsurance"]');

        btnContinue.click(function (event) {
            event.preventDefault();
            nextPage.val("credit-card");
            form.submit();
        });


        const btnSubmitInsurance = form.find('[name="SubmitInsurance"]');
        console.log(btnSubmitInsurance)
        btnSubmitInsurance.click(function (event) {
            event.preventDefault();
            nextPageVal();
            form.submit();
        });
        // if ($("input[id^=EditRecordSecondaryIns0_]").is(":checked")) {
        //     nextPage.val("secondary-insurance");
        // } else {
        //     nextPage.val("credit-card");
        // }

    });
    function nextPageVal() {
        var form = document.querySelector(
            'form[action*="F03D40005a903b8e9e674f07b4d9"] '
        );
        var createNew = form.querySelector('[name="EditRecordCreateNew"]');
        var secondaryIns = form.querySelector('[name="EditRecordSecondaryIns"]');
        var nextPage = form.querySelector('[name="EditRecordNextPage"]');
        var v3 = form.querySelector('[name="cbParamVirtual3"]');
        var v4 = form.querySelector('[name="cbParamVirtual4"]');
        var d3 = Date.parse(v3.value);
        var d4 = Date.parse(v4.value);
        console.log('Setting next page in before submit');
        if (createNew.value == "Y") {
            nextPage.value = "insurance-primary";
        } else if (secondaryIns.checked == true && d3 <= d4) {
            nextPage.value = "Secondary-Insurance";
        } else {
            nextPage.value = "Credit-Card";
        }
    }
    document.addEventListener("BeforeFormSubmit", function (event) {

        if (event.detail.appKey == "F03D40005a903b8e9e674f07b4d9") {
            nextPageVal()
        }
    });
</script>